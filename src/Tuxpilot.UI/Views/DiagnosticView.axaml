<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Tuxpilot.UI.ViewModels"
             x:Class="Tuxpilot.UI.Views.DiagnosticView"
             x:DataType="vm:DiagnosticViewModel">

    <Design.DataContext>
        <vm:DiagnosticViewModel/>
    </Design.DataContext>

    <ScrollViewer>
        <StackPanel Margin="32" Spacing="24">
            
            <!-- Header -->
            <StackPanel Spacing="8">
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <PathIcon Data="{StaticResource IconDiagnostic}" 
                              Width="32" Height="32"
                              Foreground="{DynamicResource TextPrimary}"/>
                    <TextBlock Classes="text-h1"
                              Text="Diagnostic"
                              VerticalAlignment="Center"/>
                </StackPanel>
                <TextBlock Classes="text-muted"
                          Text="Vérifiez l'état de santé de votre système Linux"/>
            </StackPanel>
            
            <!-- Indicateur de chargement -->
            <ProgressBar IsIndeterminate="True"
                        IsVisible="{Binding IsLoading}"
                        Height="4"/>
            
            <!-- Score de santé global -->
<Border Background="{DynamicResource BackgroundPrimary}"
        CornerRadius="12"
        Padding="32"
        BorderBrush="{DynamicResource BorderPrimary}"
        BorderThickness="1">
    <Grid ColumnDefinitions="Auto,*,Auto">
        
        <!-- Cercle de score -->
        <Border Grid.Column="0"
                Width="120" Height="120"
                CornerRadius="60"
                Background="{Binding BackgroundColor}"
                BorderBrush="{Binding BorderColor}"
                BorderThickness="4">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <PathIcon Data="{StaticResource {Binding IconeSanteResourceKey}}"
                          Width="40" Height="40"
                          Foreground="{Binding CouleurSante}"
                          HorizontalAlignment="Center"/>
                <TextBlock Text="{Binding ScoreTexte}"
                          FontSize="24"
                          FontWeight="Bold"
                          Foreground="{Binding CouleurSante}"
                          HorizontalAlignment="Center"
                          Margin="0,8,0,0"/>
            </StackPanel>
        </Border>
        
        <!-- Message -->
        <StackPanel Grid.Column="1"
                   Margin="24,0,0,0"
                   VerticalAlignment="Center"
                   Spacing="8">
            <TextBlock Classes="text-h2"
                      Text="État du système"/>
            <TextBlock Classes="text-body"
                      Text="{Binding MessageGlobal}"
                      FontSize="16"/>
        </StackPanel>
        
        <!-- Bouton actualiser -->
        <Button Grid.Column="2"
                Classes="btn-primary"
                Command="{Binding DiagnostiquerCommand}"
                VerticalAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <PathIcon Data="{StaticResource IconRefresh}" 
                          Width="16" Height="16"
                          Foreground="{DynamicResource BackgroundPrimary}"/>
                <TextBlock Text="Analyser"/>
            </StackPanel>
        </Button>
        
    </Grid>
</Border>
            
            <!-- Grille des cartes -->
            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="16" RowSpacing="16">
                
                <!-- Espace disque -->
                <Border Grid.Column="0" Grid.Row="0"
                        Background="{DynamicResource BackgroundPrimary}"
                        CornerRadius="12"
                        Padding="24"
                        BorderBrush="{DynamicResource BorderPrimary}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">
                        <StackPanel Spacing="4">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <PathIcon Data="{StaticResource IconDisk}" 
                                          Width="20" Height="20"
                                          Foreground="{DynamicResource TextPrimary}"
                                          VerticalAlignment="Center"/>
                                <TextBlock Classes="text-h3"
                                          Text="Espace disque"
                                          VerticalAlignment="Center"/>
                            </StackPanel>
                            <TextBlock Classes="text-muted"
                                      Text="{Binding Disque.Partition}"/>
                        </StackPanel>
                        
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="Auto,*">
                                <TextBlock Grid.Column="0"
                                          Classes="text-muted"
                                          Text="Taille"
                                          Width="100"/>
                                <TextBlock Grid.Column="1"
                                          Classes="text-body"
                                          Text="{Binding Disque.Taille}"
                                          FontWeight="Medium"/>
                            </Grid>
                            
                            <Grid ColumnDefinitions="Auto,*">
                                <TextBlock Grid.Column="0"
                                          Classes="text-muted"
                                          Text="Utilisé"
                                          Width="100"/>
                                <TextBlock Grid.Column="1"
                                          Classes="text-body"
                                          Text="{Binding Disque.Utilise}"
                                          FontWeight="Medium"/>
                            </Grid>
                            
                            <Grid ColumnDefinitions="Auto,*">
                                <TextBlock Grid.Column="0"
                                          Classes="text-muted"
                                          Text="Disponible"
                                          Width="100"/>
                                <TextBlock Grid.Column="1"
                                          Classes="text-body"
                                          Text="{Binding Disque.Disponible}"
                                          FontWeight="Medium"/>
                            </Grid>
                        </StackPanel>
                        
                        <!-- Barre de progression -->
                        <StackPanel Spacing="4">
                            <ProgressBar Value="{Binding Disque.Pourcentage}"
                                        Maximum="100"
                                        Height="8"
                                        CornerRadius="4"/>
                            <TextBlock Classes="text-sm"
                                      HorizontalAlignment="Right">
                                <Run Text="{Binding Disque.Pourcentage}"/>
                                <Run Text="%"/>
                            </TextBlock>
                        </StackPanel>
                    </StackPanel>
                </Border>
                
               <!-- Services en erreur -->
<Border Grid.Column="1" Grid.Row="0"
        Background="{DynamicResource BackgroundPrimary}"
        CornerRadius="12"
        Padding="24"
        BorderBrush="{DynamicResource BorderPrimary}"
        BorderThickness="1">
    <StackPanel Spacing="16">
        <StackPanel Orientation="Horizontal" Spacing="12">
            <PathIcon Data="{StaticResource IconServices}" 
                      Width="20" Height="20"
                      Foreground="{DynamicResource TextPrimary}"
                      VerticalAlignment="Center"/>
            <TextBlock Classes="text-h3"
                      Text="Services en erreur"
                      VerticalAlignment="Center"/>
        </StackPanel>
        
        <StackPanel Spacing="8">
            <Border Background="{DynamicResource BackgroundDanger}"
                    CornerRadius="8"
                    Padding="16,12">
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <PathIcon Data="{StaticResource IconAlertCircle}" 
                              Width="32" Height="32"
                              Foreground="{DynamicResource Danger}"/>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock FontSize="32"
                                  FontWeight="Bold"
                                  Foreground="{DynamicResource Danger}"
                                  Text="{Binding NombreServicesErreur}"/>
                        <TextBlock Classes="text-sm"
                                  Foreground="{DynamicResource Danger}"
                                  Text="service(s) en erreur"/>
                    </StackPanel>
                </StackPanel>
            </Border>
            
            <!-- ✅ CORRIGÉ : Services au lieu de ServicesErreur -->
            <ItemsControl ItemsSource="{Binding Services}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Background="{DynamicResource BackgroundSecondary}"
                                CornerRadius="6"
                                Padding="12"
                                Margin="0,0,0,8">
                            <Grid ColumnDefinitions="Auto,*">
                                <PathIcon Grid.Column="0"
                                          Data="{StaticResource IconClose}" 
                                          Width="16" Height="16"
                                          Foreground="{DynamicResource Danger}"
                                          Margin="0,0,8,0"
                                          VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1"
                                          Classes="text-body"
                                          Text="{Binding Nom}"
                                          FontWeight="Medium"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </StackPanel>
    </StackPanel>
</Border>
                
                <!-- Top processus CPU -->
                <Border Grid.Column="0" Grid.Row="1"
                        Background="{DynamicResource BackgroundPrimary}"
                        CornerRadius="12"
                        Padding="24"
                        BorderBrush="{DynamicResource BorderPrimary}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <PathIcon Data="{StaticResource IconCpu}" 
                                      Width="20" Height="20"
                                      Foreground="{DynamicResource TextPrimary}"
                                      VerticalAlignment="Center"/>
                            <TextBlock Classes="text-h3"
                                      Text="Top CPU"
                                      VerticalAlignment="Center"/>
                        </StackPanel>
                        
                        <ItemsControl ItemsSource="{Binding TopCpu}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource BackgroundSecondary}"
                                            CornerRadius="6"
                                            Padding="12"
                                            Margin="0,0,0,8">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <StackPanel Grid.Column="0" Spacing="2">
                                                <TextBlock Classes="text-body"
                                                          Text="{Binding Nom}"
                                                          FontWeight="Medium"
                                                          TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Classes="text-sm">
                                                    <Run Text="PID: "/>
                                                    <Run Text="{Binding Pid}"/>
                                                </TextBlock>
                                            </StackPanel>
                                            <Border Grid.Column="1"
                                                    Background="{DynamicResource BackgroundInfo}"
                                                    CornerRadius="8"
                                                    Padding="8,4"
                                                    VerticalAlignment="Center">
                                                <TextBlock Classes="text-sm"
                                                          FontWeight="SemiBold"
                                                          Foreground="{DynamicResource TextInfo}">
                                                    <Run Text="{Binding Cpu}"/>
                                                    <Run Text="%"/>
                                                </TextBlock>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
                
                <!-- Top processus RAM -->
                <Border Grid.Column="1" Grid.Row="1"
                        Background="{DynamicResource BackgroundPrimary}"
                        CornerRadius="12"
                        Padding="24"
                        BorderBrush="{DynamicResource BorderPrimary}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <PathIcon Data="{StaticResource IconMemory}" 
                                      Width="20" Height="20"
                                      Foreground="{DynamicResource TextPrimary}"
                                      VerticalAlignment="Center"/>
                            <TextBlock Classes="text-h3"
                                      Text="Top RAM"
                                      VerticalAlignment="Center"/>
                        </StackPanel>
                        
                        <ItemsControl ItemsSource="{Binding TopRam}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource BackgroundSecondary}"
                                            CornerRadius="6"
                                            Padding="12"
                                            Margin="0,0,0,8">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <StackPanel Grid.Column="0" Spacing="2">
                                                <TextBlock Classes="text-body"
                                                          Text="{Binding Nom}"
                                                          FontWeight="Medium"
                                                          TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Classes="text-sm">
                                                    <Run Text="PID: "/>
                                                    <Run Text="{Binding Pid}"/>
                                                </TextBlock>
                                            </StackPanel>
                                            <Border Grid.Column="1"
                                                    Background="{DynamicResource BackgroundWarning}"
                                                    CornerRadius="8"
                                                    Padding="8,4"
                                                    VerticalAlignment="Center">
                                                <TextBlock Classes="text-sm"
                                                          FontWeight="SemiBold"
                                                          Foreground="{DynamicResource Warning}">
                                                    <Run Text="{Binding Ram}"/>
                                                    <Run Text="%"/>
                                                </TextBlock>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
                
            </Grid>
            
            <!-- Logs récents -->
            <Border Background="{DynamicResource BackgroundPrimary}"
                    CornerRadius="12"
                    Padding="24"
                    BorderBrush="{DynamicResource BorderPrimary}"
                    BorderThickness="1"
                    IsVisible="{Binding LogsPresents}">
                <StackPanel Spacing="16">
                    <StackPanel Spacing="4">
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <PathIcon Data="{StaticResource IconList}" 
                                      Width="20" Height="20"
                                      Foreground="{DynamicResource TextPrimary}"
                                      VerticalAlignment="Center"/>
                            <TextBlock Classes="text-h3"
                                      Text="Logs récents (24h)"
                                      VerticalAlignment="Center"/>
                        </StackPanel>
                        <TextBlock Classes="text-muted">
                            <Run Text="{Binding NombreLogs}"/>
                            <Run Text=" erreur(s) détectée(s)"/>
                        </TextBlock>
                    </StackPanel>
                    
                    <ScrollViewer MaxHeight="300">
                        <ItemsControl ItemsSource="{Binding Logs}">
                           <ItemsControl ItemsSource="{Binding Logs}">
    <ItemsControl.ItemTemplate>
        <DataTemplate>
            <Border Background="{Binding BackgroundColor}"
                    CornerRadius="6"
                    Padding="12"
                    Margin="0,0,0,8">
                <StackPanel Spacing="4">
                    <Grid ColumnDefinitions="Auto,Auto,*">
                        <!-- Icône de sévérité avec PathIcon -->
                        <PathIcon Grid.Column="0"
                                 Data="{StaticResource {Binding IconResourceKey}}"
                                 Width="16" Height="16"
                                 Foreground="{Binding IconColor}"
                                 VerticalAlignment="Center"
                                 Margin="0,0,8,0"/>
        
                        <!-- Timestamp avec couleur fixe -->
                        <TextBlock Grid.Column="1"
                                  Classes="text-sm"
                                  Text="{Binding Timestamp}"
                                  Foreground="{DynamicResource TextMuted}"
                                  Width="150"
                                  VerticalAlignment="Center"/>
        
                        <!-- Service avec couleur dynamique -->
                        <TextBlock Grid.Column="2"
                                  Classes="text-sm"
                                  Text="{Binding Service}"
                                  FontWeight="SemiBold"
                                  Foreground="{Binding ServiceColor}"
                                  VerticalAlignment="Center"/>
                    </Grid>

                    <!-- Message avec couleur foncée pour lisibilité -->
                    <TextBlock Classes="text-sm"
                              Text="{Binding Message}"
                              TextWrapping="Wrap"
                              Foreground="{Binding MessageColor}"/>
                </StackPanel>
            </Border>
        </DataTemplate>
    </ItemsControl.ItemTemplate>
</ItemsControl>
                        </ItemsControl>
                    </ScrollViewer>
                </StackPanel>
            </Border>
            
        </StackPanel>
    </ScrollViewer>
    
</UserControl>