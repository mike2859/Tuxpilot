<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Tuxpilot.UI.ViewModels"
             xmlns:converters="using:Tuxpilot.UI.Converters"
             x:Class="Tuxpilot.UI.Views.AssistantIAView"
             x:DataType="vm:AssistantIAViewModel">

    <Design.DataContext>
        <vm:AssistantIAViewModel/>
    </Design.DataContext>

    <UserControl.Resources>
        <converters:BoolToAlignmentConverter x:Key="BoolToAlignmentConverter"/>
        <converters:BoolToNameConverter x:Key="BoolToNameConverter"/>
    </UserControl.Resources>
    
    <Grid RowDefinitions="Auto,*,Auto">
        
        <!-- Header -->
        <StackPanel Grid.Row="0" Spacing="8" Margin="32,32,32,16">
            <StackPanel Orientation="Horizontal" Spacing="12">
                <PathIcon Data="{StaticResource IconRobot}" 
                          Width="32" Height="32"
                          Foreground="{DynamicResource TextPrimary}"/>
                <TextBlock Classes="text-h1"
                          Text="Assistant IA"
                          VerticalAlignment="Center"/>
            </StackPanel>
            <TextBlock Classes="text-muted"
                      Text="Posez vos questions sur Linux, Fedora, et l'administration système"/>
        </StackPanel>
        
        <!-- Zone de messages (chat) -->
        <Border Grid.Row="1"
                Background="{DynamicResource BackgroundPrimary}"
                CornerRadius="12"
                Margin="32,0,32,16"
                BorderBrush="{DynamicResource BorderPrimary}"
                BorderThickness="1">
            
            <Grid RowDefinitions="Auto,*">
                
                <!-- Toolbar -->
                <Border Grid.Row="0"
                        Background="{DynamicResource BackgroundSecondary}"
                        BorderBrush="{DynamicResource BorderPrimary}"
                        BorderThickness="0,0,0,1"
                        Padding="16,12">
                    <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                            <PathIcon Data="{StaticResource IconChat}" 
                                      Width="18" Height="18"
                                      Foreground="{DynamicResource TextPrimary}"
                                      VerticalAlignment="Center"/>
                            <TextBlock Classes="text-body"
                                      Text="Conversation"
                                      FontWeight="SemiBold"
                                      VerticalAlignment="Center"/>
                        </StackPanel>
                        
                        <Button Grid.Column="1"
                                Classes="btn-secondary btn-sm"
                                Command="{Binding EffacerHistoriqueCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <PathIcon Data="{StaticResource IconTrash}" 
                                          Width="14" Height="14"
                                          Foreground="{DynamicResource TextPrimary}"/>
                                <TextBlock Text="Effacer"/>
                            </StackPanel>
                        </Button>

                         <TextBlock Grid.Column="2"
                            Classes="text-muted"
                            Text="{Binding EtatContexte}"
                            VerticalAlignment="Center"
                            Margin="0,0,12,0"/>

                        <Button Grid.Column="2"
                                Classes="btn-secondary btn-sm"
                                Command="{Binding RafraichirContexteCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <PathIcon Data="{StaticResource IconRefresh}"
                                    Width="14" Height="14"
                                    Foreground="{DynamicResource TextPrimary}"/>
                            <TextBlock Text="Actualiser"/>
                        </StackPanel>
                        </Button>
                    </Grid>
                </Border>
                
                <!-- Messages scrollable -->
                <ScrollViewer Grid.Row="1"
                             x:Name="MessagesScrollViewer"
                             Padding="16"
                             VerticalScrollBarVisibility="Auto">

                    <StackPanel Spacing="12">

                    <!-- Setup Ollama (visible quand IA non prête) -->
                    <Border Padding="12"
                            CornerRadius="10"
                            Background="{DynamicResource BackgroundSecondary}"
                            BorderBrush="{DynamicResource BorderPrimary}"
                            BorderThickness="1"
                            IsVisible="{Binding OllamaNotReady}">
                        <StackPanel Spacing="8">
                        <TextBlock Text="{Binding OllamaStatusMessage}"
                                    FontWeight="SemiBold"
                                    Foreground="{DynamicResource TextPrimary}"/>

                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <TextBlock Text="Modèle :" VerticalAlignment="Center"
                                    Foreground="{DynamicResource TextSecondary}"/>
                            <TextBox Width="220" Text="{Binding ModeleChoisi}" />
                            <Button Classes="btn-secondary btn-sm"
                                    Command="{Binding ChargerEtatOllamaCommand}"
                                    Content="Vérifier"/>
                        </StackPanel>

                        <ItemsControl ItemsSource="{Binding OllamaActions}">
                            <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <DockPanel LastChildFill="False">
                                <StackPanel DockPanel.Dock="Left" Spacing="2">
                                    <TextBlock Text="{Binding Label}" FontWeight="SemiBold"
                                            Foreground="{DynamicResource TextPrimary}"/>
                                    <TextBlock Text="{Binding Notes}" FontSize="12"
                                            Foreground="{DynamicResource TextSecondary}"/>
                                </StackPanel>

                                <Button DockPanel.Dock="Right"
                                        Classes="btn-primary btn-sm"
                                        Content="Appliquer"
                                        Command="{Binding $parent[ItemsControl].((vm:AssistantIAViewModel)DataContext).ExecuterOllamaActionCommand}"
                                        CommandParameter="{Binding}"/>
                                </DockPanel>
                            </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <TextBlock Text="Certaines actions demandent votre mot de passe (pkexec)."
                                    FontSize="12"
                                    Foreground="{DynamicResource TextSecondary}"/>
                        </StackPanel>
                    </Border>


                    <ItemsControl ItemsSource="{Binding Messages}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Spacing="8" Margin="0,0,0,12">
                                    
                                    <!-- Message principal -->
                                    <Border Background="{Binding BackgroundColor}"
                                            CornerRadius="12"
                                            Padding="16"
                                            MaxWidth="600"
                                            HorizontalAlignment="{Binding IsUser, Converter={StaticResource BoolToAlignmentConverter}}">
                                        <StackPanel Spacing="8">
                                            <!-- Icône et nom -->
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding Icone}"
                                                        FontSize="16"/>
                                                <TextBlock Classes="text-body"
                                                        Text="{Binding IsUser, Converter={StaticResource BoolToNameConverter}}"
                                                        FontWeight="SemiBold"/>
                                            </StackPanel>
                                            
                                            <!-- Message -->
                                            <TextBlock Classes="text-body"
                                                    Text="{Binding Texte}"
                                                    TextWrapping="Wrap"
                                                    Foreground="{Binding TextColor}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- ENCART D'ACTION -->
                                    <Border Background="#FEF3C7"
                                            CornerRadius="12"
                                            Padding="16"
                                            BorderBrush="#F59E0B"
                                            BorderThickness="2"
                                            MaxWidth="600"
                                            HorizontalAlignment="Left"
                                            IsVisible="{Binding HasAction}">
                                        <StackPanel Spacing="12">
                                            
                                            <!-- Header -->
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <PathIcon Data="{StaticResource IconLightbulb}" 
                                                        Width="20" Height="20"
                                                        Foreground="#92400E"/>
                                                <TextBlock Classes="text-body"
                                                        Text="Je peux faire ça pour vous !"
                                                        FontWeight="Bold"
                                                        Foreground="#92400E"
                                                        VerticalAlignment="Center"/>
                                            </StackPanel>
                                            
                                            <!-- Commande -->
                                            <Border Background="#FFFBEB"
                                                    CornerRadius="8"
                                                    Padding="12"
                                                    BorderBrush="#FCD34D"
                                                    BorderThickness="1">
                                                <StackPanel Spacing="4">
                                                    <TextBlock Classes="text-sm"
                                                            Text="Commande :"
                                                            Foreground="#92400E"
                                                            FontWeight="SemiBold"/>
                                                    <TextBlock Classes="text-body"
                                                            Text="{Binding Action.Command}"
                                                            FontFamily="monospace"
                                                            Foreground="#78350F"
                                                            TextWrapping="Wrap"/>
                                                </StackPanel>
                                            </Border>
                                            
                                            <!-- Boutons -->
                                            <Grid ColumnDefinitions="*,*" ColumnSpacing="8"
                                                IsVisible="{Binding !ActionExecuted}">
                                                <Button Grid.Column="0"
                                                        Classes="btn-primary"
                                                        Command="{Binding $parent[ItemsControl].((vm:AssistantIAViewModel)DataContext).ExecuterActionCommand}"
                                                        CommandParameter="{Binding}"
                                                        HorizontalAlignment="Stretch">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <PathIcon Data="{StaticResource IconCheck}" 
                                                                Width="14" Height="14"
                                                                Foreground="{DynamicResource BackgroundPrimary}"/>
                                                        <TextBlock Text="Exécuter"/>
                                                    </StackPanel>
                                                </Button>
                                                <Button Grid.Column="1"
                                                        Classes="btn-secondary"
                                                        Command="{Binding $parent[ItemsControl].((vm:AssistantIAViewModel)DataContext).RefuserActionCommand}"
                                                        CommandParameter="{Binding}"
                                                        HorizontalAlignment="Stretch">
                                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                                        <PathIcon Data="{StaticResource IconClose}" 
                                                                Width="14" Height="14"
                                                                Foreground="{DynamicResource TextPrimary}"/>
                                                        <TextBlock Text="Non merci"/>
                                                    </StackPanel>
                                                </Button>
                                            </Grid>
                                            
                                            <!-- Résultat -->
                                            <Border Background="#D1FAE5"
                                                    CornerRadius="8"
                                                    Padding="12"
                                                    IsVisible="{Binding ActionExecuted}">
                                                <TextBlock Classes="text-body"
                                                        Text="{Binding ActionResult}"
                                                        Foreground="#065F46"
                                                        FontWeight="SemiBold"/>
                                            </Border>
                                            
                                        </StackPanel>
                                    </Border>
                                    
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    </StackPanel>
                </ScrollViewer>
                
            </Grid>
        </Border>
        
        <!-- Zone de saisie et boutons -->
        <Grid Grid.Row="2"
              Margin="32,0,32,32"
              RowDefinitions="Auto,Auto">
            
            <!-- Questions rapides -->
            <ScrollViewer Grid.Row="0"
                         HorizontalScrollBarVisibility="Auto"
                         VerticalScrollBarVisibility="Disabled"
                         Margin="0,0,0,12">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Classes="btn-outline btn-sm"
                            Command="{Binding PoserQuestionRapideCommand}"
                            CommandParameter="Comment installer des mises à jour sur Fedora ?">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <PathIcon Data="{StaticResource IconLightbulb}" 
                                      Width="14" Height="14"
                                      Foreground="{DynamicResource Primary}"/>
                            <TextBlock Text="Comment installer des updates ?"/>
                        </StackPanel>
                    </Button>
                    
                    <Button Classes="btn-outline btn-sm"
                            Command="{Binding PoserQuestionRapideCommand}"
                            CommandParameter="Qu'est-ce que dnf5 et en quoi c'est différent de dnf ?">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <PathIcon Data="{StaticResource IconQuestion}" 
                                      Width="14" Height="14"
                                      Foreground="{DynamicResource Primary}"/>
                            <TextBlock Text="C'est quoi dnf5 ?"/>
                        </StackPanel>
                    </Button>
                    
                    <Button Classes="btn-outline btn-sm"
                            Command="{Binding PoserQuestionRapideCommand}"
                            CommandParameter="Comment voir les logs système avec journalctl ?">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <PathIcon Data="{StaticResource IconList}" 
                                      Width="14" Height="14"
                                      Foreground="{DynamicResource Primary}"/>
                            <TextBlock Text="Voir les logs système"/>
                        </StackPanel>
                    </Button>
                    
                    <Button Classes="btn-outline btn-sm"
                            Command="{Binding PoserQuestionRapideCommand}"
                            CommandParameter="Comment nettoyer le cache des paquets DNF ?">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <PathIcon Data="{StaticResource IconCleanup}" 
                                      Width="14" Height="14"
                                      Foreground="{DynamicResource Primary}"/>
                            <TextBlock Text="Nettoyer le cache"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </ScrollViewer>
            
            <!-- Champ de saisie -->
            <Grid Grid.Row="1"
                  ColumnDefinitions="*,Auto,">
                <TextBox Grid.Column="0"
                         Text="{Binding QuestionUtilisateur}"
                         Watermark="{Binding MessagePlaceholder}"
                         Padding="16,12"
                         CornerRadius="8"
                         Background="{DynamicResource BackgroundPrimary}"
                         BorderBrush="{DynamicResource BorderSecondary}"
                         BorderThickness="1"
                         FontSize="14">
                    <TextBox.KeyBindings>
                        <KeyBinding Gesture="Enter"
                                    Command="{Binding EnvoyerQuestionCommand}"/>
                    </TextBox.KeyBindings>
                </TextBox>
                
                <Button Grid.Column="1"
                        Classes="btn-primary"
                        Command="{Binding EnvoyerQuestionCommand}"
                        IsEnabled="{Binding !IsStreaming}"
                        Margin="8,0,0,0"
                        Padding="20,12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <PathIcon Data="{StaticResource IconSend}" 
                                  Width="16" Height="16"
                                  Foreground="{DynamicResource BackgroundPrimary}"/>
                        <TextBlock Text="Envoyer"/>
                    </StackPanel>
                </Button>
            </Grid>
            
        </Grid>
        
    </Grid>

</UserControl>